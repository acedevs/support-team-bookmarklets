(function(){
  var token = $.cookie('token');

  var parts = /\/c\/([^/]+)/.exec(document.location);

  if(!parts) {
    alert("No cards are open.")
    return;
  }
  var idCard = parts[1];
  $.get("/1/cards/" + idCard, { fields: "idList", checklists: "all" })
  .success(function(json){
    var idList = json.idList;
    var checklists = json.checklists;

    var checkItems = [];
    
    _.sortBy(checklists, 'pos').forEach(function(checklist){
      var idChecklist = checklist.id;
      checklist.checkItems.forEach(function(checkItem){
        checkItems.push({
          idChecklist: idChecklist,
          name: checkItem.name,
          id: checkItem.id
        })
      })
    })

    var createNextCard = function() {
      if(checkItems.length == 0) {
        return;
      }
      var checkItem = checkItems.shift();
      
      // Do something with the checkitem
      $.post("/1/card", {
        token: token,
        idList: idList,
        name: checkItem.name,
        pos: 'bottom'
      })
      .success(function(response){
        $.ajax({
          method: 'put',
          url: '/1/cards/' + idCard + '/checklist/' + checkItem.idChecklist + '/checkItem/' + checkItem.id,
          data: {
            name: response.url,
            token: token
          }
        })
        createNextCard();
      })

    }

    createNextCard();

  })
})();